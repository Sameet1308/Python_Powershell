import boto3
import json
import logging

logger = logging.getLogger()
logger.setLevel(logging.INFO)

def create_table_in_glue(glue_client, database_name, table_name):
    try:
        glue_client.create_table(
            DatabaseName=database_name,
            TableInput={
                'Name': table_name,
                'StorageDescriptor': {
                    'Columns': [
                        {'Name': 'id', 'Type': 'int'},
                        {'Name': 'name', 'Type': 'string'}
                    ],
                    'Compressed': False,
                    'NumberOfBuckets': -1,
                    'SerdeInfo': {
                        'SerializationLibrary': 'org.apache.hadoop.hive.serde2.lazy.LazySimpleSerDe',
                        'Parameters': {'serialization.format': '1'}
                    },
                    'StoredAsSubDirectories': False
                },
                'TableType': 'EXTERNAL_TABLE',
                'Parameters': {
                    'EXTERNAL': 'TRUE'
                }
            }
        )
        logger.info(f"Table {table_name} created successfully in database {database_name}.")
    except Exception as e:
        logger.error(f"Error creating table: {str(e)}")

def lambda_handler(event, context):
    # Define the parameters
    target_account_id = 'TARGET_ACCOUNT_ID'
    role_name = 'ROLE_NAME_WITH_CROSS_ACCOUNT_ACCESS'
    database_name = 'TARGET_DATABASE_NAME'
    table_name = 'NEW_TABLE_NAME'
    
    # Assume role for cross-account access
    sts_client = boto3.client('sts')
    role_arn = f'arn:aws:iam::{target_account_id}:role/{role_name}'
    
    assumed_role = sts_client.assume_role(
        RoleArn=role_arn,
        RoleSessionName='AssumeRoleSession'
    )
    
    credentials = assumed_role['Credentials']
    
    # Create Glue client with assumed role credentials
    glue_client = boto3.client(
        'glue',
        aws_access_key_id=credentials['AccessKeyId'],
        aws_secret_access_key=credentials['SecretAccessKey'],
        aws_session_token=credentials['SessionToken']
    )
    
    # Create table in Glue
    create_table_in_glue(glue_client, database_name, table_name)
    
    return {
        'statusCode': 200,
        'body': json.dumps('Table creation triggered successfully')
    }
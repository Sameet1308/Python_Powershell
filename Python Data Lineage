import pandas as pd
from mstrio.connection import Connection
from mstrio.cube import Cube, list_cubes

# Replace these variables with your actual credentials
base_url = 'YOUR_BASE_URL'  # e.g., 'https://your-microstrategy-server.com/MicroStrategyLibrary/api'
username = 'YOUR_USERNAME'
password = 'YOUR_PASSWORD'
project_name = 'YOUR_PROJECT_NAME'

# Establish a connection to the MicroStrategy server
conn = Connection(base_url, username, password, project_name)

try:
    # Connect to the project
    conn.connect()

    # Fetch all cubes
    cubes = list_cubes(connection=conn, project_id=conn.project_id)

    freeform_sql_cubes = []
    # Check each cube to see if it's a freeform SQL cube
    for cube_info in cubes:
        cube = Cube(connection=conn, cube_id=cube_info['id'])
        cube.fetch()

        # Example condition: checking if the cube's definition contains SQL
        # Adjust this based on your organization's specifics
        if 'sql' in cube.definition.lower():
            freeform_sql_cubes.append({
                'Cube ID': cube_info['id'],
                'Cube Name': cube_info['name'],
                'Definition': cube.definition
            })

    # Counting the freeform SQL cubes
    print("Total number of Freeform SQL Cubes:", len(freeform_sql_cubes))

    # Exporting to Excel
    df = pd.DataFrame(freeform_sql_cubes)
    df.to_excel('freeform_sql_cubes.xlsx', index=False)

    print("Data exported to Excel successfully.")

finally:
    # Disconnect the session
    conn.close()